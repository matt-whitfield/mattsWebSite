---
import { getCollection, getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import StyledLink from '../../components/StyledLink.astro';
import ContactCTA from '../../components/ContactCTA.astro';

// Generate pages for all blog posts
export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

// Get the blog post data for this page
const { entry } = Astro.props;
const { Content } = await entry.render();

// Get other blog posts for the "Related Articles" section
const allBlogPosts = await getCollection('blog');
const otherPosts = allBlogPosts
  .filter(post => post.slug !== entry.slug)
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime())
  .slice(0, 3);

// Format the publish date
const formattedDate = entry.data.publishDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Map category to appropriate text color for the badge
const textColorMap = {
  mint: 'text-black',
  lime: 'text-black', 
  highlight: 'text-black',
  primary: 'text-white',
  coral: 'text-white',
  blue: 'text-white',
  purple: 'text-white'
};

const textColor = textColorMap[entry.data.color] || 'text-white';
---

<Layout 
  title={entry.data.seo?.title || `${entry.data.title} | Blog | Matt Whitfield - Web Designer & Developer`}
  description={entry.data.seo?.description || entry.data.description}
  image={entry.data.image || "/images/mw-headshots-2024.webp"}
>
  <main class="bg-white">
    <!-- Hero Section with Full-Width Background -->
    <section class="w-full relative pt-32 pb-20">
      <!-- Dynamic background gradient based on blog post color -->
      <div class={`absolute inset-0 w-full h-full bg-gradient-to-br from-white via-white to-${entry.data.color}/10`}></div>
      
      <div class="page-container relative z-1">
        <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8 lg:gap-16 items-start">
          <div>
            <div class="mb-6 flex items-center gap-4">
              <span class={`inline-block font-serif text-sm font-medium uppercase tracking-wider bg-${entry.data.color} ${textColor} py-1 px-3 border-3 border-black`}>
                {entry.data.category}
              </span>
              <span class="text-muted">{formattedDate}</span>
              {entry.data.readTime && (
                <span class="text-muted">·</span>
                <span class="text-muted">{entry.data.readTime}</span>
              )}
            </div>
            
            <h1 class="neo-heading text-4xl md:text-5xl lg:text-6xl mb-8 text-text leading-tight">{entry.data.title}</h1>
            
            <div class="relative mt-8 mb-12 max-w-prose">
              <div class="neo-card-base p-6">
                <p class="neo-text text-lg mb-0">
                  {entry.data.description}
                </p>
              </div>
              
              {entry.data.featured && (
                <div class={`absolute -top-6 -right-6 p-2 bg-${entry.data.color} border-3 border-black ${textColor} font-serif font-bold text-base uppercase rotate-3`}>
                  Featured
                </div>
              )}
            </div>
            
            <div class="mb-8">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-lightgray border-3 border-black overflow-hidden">
                  <img 
                    src="/images/mw-headshots-2024.webp" 
                    alt="Matt Whitfield"
                    class="w-full h-full object-cover"
                  />
                </div>
                <div>
                  <p class="font-serif font-bold mb-0">By {entry.data.author}</p>
                  <p class="neo-text text-sm text-muted">Web Designer & Developer</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="sticky top-24">
            <div class="neo-card-base">
              <h2 class="neo-card-title mb-6">In This Article</h2>
              <div class="space-y-4">
                <p class="neo-text text-sm mb-4">
                  {entry.data.tags.join(' • ')}
                </p>
                <StyledLink href="/blog" variant={`secondary-${entry.data.color}`} size="sm">
                  ← Back to Blog
                </StyledLink>
                <StyledLink href="/contact" variant={`secondary-${entry.data.color}`} size="md">
                  Start Your Project
                </StyledLink>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Blog Post Content Section -->
    <section class="w-full relative py-16">
      <div class={`absolute inset-0 w-full h-full bg-gradient-to-tl from-white via-white to-${entry.data.color}/5`}></div>
      
      <div class="container-narrow relative z-1">
        <article class="prose prose-lg max-w-none">
          <Content />
        </article>
      </div>
    </section>
    
    <!-- Related Articles Section -->
    <section class="w-full relative py-16">
      <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-white via-white to-coral/10"></div>
      
      <div class="page-container relative z-1">
        <h2 class="neo-heading text-3xl md:text-4xl mb-12 text-center">Related Articles</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {otherPosts.map(post => {
            const postDate = post.data.publishDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            const postTextColor = textColorMap[post.data.color] || 'text-white';
            
            return (
              <div class={`neo-card-base neo-service-card-hover-${post.data.color} overflow-hidden p-0`}>
                <div class="p-6">
                  <div class="mb-3 flex items-center">
                    <span class={`inline-block bg-${post.data.color} ${postTextColor} text-sm font-bold py-1 px-3 border-2 border-black mr-2`}>
                      {post.data.category}
                    </span>
                    <span class="text-sm text-muted">{postDate}</span>
                  </div>
                  <h3 class="neo-card-title">{post.data.title}</h3>
                  <p class="neo-text mb-6">{post.data.description}</p>
                  <StyledLink 
                    href={`/blog/${post.slug}`} 
                    variant={`secondary-${post.data.color}`} 
                    size="sm"
                  >
                    Read Article
                  </StyledLink>
                </div>
              </div>
            )
          })}
        </div>
      </div>
    </section>
    
    <!-- Newsletter Signup CTA -->
    <section class="w-full relative py-20">
      <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-white via-white to-primary/10"></div>
      
      <div class="page-container relative z-1">
        <div class="neo-card-base py-12 px-8 md:px-12 relative">
          <div class="absolute -top-6 -left-6 p-2 bg-primary border-3 border-black text-white font-serif font-bold text-xl uppercase">
            Stay Updated
          </div>
          
          <div class="flex flex-col md:flex-row gap-12 items-start">
            <div class="md:w-2/3">
              <h2 class="neo-heading text-3xl md:text-4xl mb-4 text-text">Get design and development tips in your inbox</h2>
              <p class="neo-text mb-6">
                Join my newsletter for practical advice on web design, development, and marketing for small businesses. No spam, just useful content delivered monthly.
              </p>
            </div>
            
            <div class="md:w-1/3 w-full">
              <StyledLink href="/contact" variant="primary" size="lg">
                Get in Touch
              </StyledLink>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</Layout>

<style>
  /* Prose styling for blog content */
  .prose {
    @apply text-text;
  }
  
  .prose h2 {
    @apply neo-heading text-2xl md:text-3xl mb-6 mt-12 border-b-3 border-black pb-4 inline-block;
  }
  
  .prose h3 {
    @apply neo-subheading text-xl md:text-2xl mb-4 mt-8;
  }
  
  .prose h4 {
    @apply neo-subheading text-lg md:text-xl mb-3 mt-6;
  }
  
  .prose p {
    @apply neo-text mb-6;
  }
  
  .prose ul, .prose ol {
    @apply mb-6 pl-6;
  }
  
  .prose li {
    @apply neo-text mb-2;
  }
  
  .prose strong {
    @apply font-bold;
  }
  
  .prose em {
    @apply italic;
  }
  
  .prose blockquote {
    @apply border-l-4 border-primary pl-6 italic text-lg my-8;
  }
  
  .prose code {
    @apply bg-lightgray px-2 py-1 rounded text-sm font-mono;
  }
  
  .prose pre {
    @apply bg-lightgray p-4 rounded overflow-x-auto mb-6;
  }
  
  .prose a {
    @apply neo-inline-link;
  }
</style>
